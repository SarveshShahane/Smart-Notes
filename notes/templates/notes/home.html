<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Notes</title>
    <style>
    body {
      background: #f4f6f8;
      color: #222;
      transition: background 0.3s, color 0.3s;
    }
    .notes-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin: 20px;
    }
    .note-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s, color 0.3s;
    }
    .note-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    .note-card h2 {
      font-size: 1.3rem;
      margin-bottom: 8px;
      color: #333;
      transition: color 0.3s;
    }
    .note-content {
      margin-bottom: 10px;
      line-height: 1.4;
      color: #555;
      transition: color 0.3s;
      word-break: break-word;
    }
    .note-tags {
      font-size: 0.9rem;
      color: #007bff;
      font-style: italic;
      margin-bottom: 12px;
      transition: color 0.3s;
    }
    .note-delete, .note-export, .note-copy {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
      margin-right: 8px;
      cursor: pointer;
      border: none;
    }
    .note-delete {
      background-color: #dc3545;
      color: #fff;
    }
    .note-delete:hover {
      background-color: #a71d2a;
    }
    .note-export {
      background-color: #1976d2;
      color: #fff;
    }
    .note-export:hover {
      background-color: #004ba0;
    }
    .note-copy {
      background-color: #28a745;
      color: #fff;
    }
    .note-copy:hover {
      background-color: #1e7e34;
    }
    .note-reactions {
      margin-top: 10px;
    }
    .emoji-btn {
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 6px;
    }
    .emoji-count {
      font-size: 1rem;
      margin-right: 12px;
    }
    body.dark-mode {
      background: #181a1b;
      color: #e2e2e2;
    }
    body.dark-mode .note-card {
      background: #23272b;
      border-color: #444;
      color: #e2e2e2;
    }
    body.dark-mode .note-card h2 {
      color: #e2e2e2;
    }
    body.dark-mode .note-content {
      color: #bdbdbd;
    }
    body.dark-mode .note-tags {
      color: #90caf9;
    }
    body.dark-mode .note-delete {
      background-color: #b71c1c;
      color: #fff;
    }
    body.dark-mode .note-delete:hover {
      background-color: #7f0000;
    }
    body.dark-mode .note-export {
      background-color: #1565c0;
      color: #fff;
    }
    body.dark-mode .note-export:hover {
      background-color: #002171;
    }
    body.dark-mode .note-copy {
      background-color: #2e7d32;
      color: #fff;
    }
    body.dark-mode .note-copy:hover {
      background-color: #1b5e20;
    }
    .copy-feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      font-size: 14px;
      z-index: 1000;
      animation: slideIn 0.3s ease, slideOut 0.3s ease 2s forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    </style>
</head>
<body>
    <div>{% include 'notes/navbar.html' %}</div>
    {% if messages %}
    <div class="messages" id="flash-messages">
      {% for message in messages %}
        <div class="alert {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <div class="notes-container">
      {% for note in notes %}
          <div class="note-card" data-title="{{ note.title }}">
              <h2>{{ note.title }}</h2>
              <div class="note-content">{{ note.content }}</div>
              <p class="note-tags">Tags: {{ note.tags }}</p>
              <button class="note-delete" onclick="confirmDelete({{ note.id }}, '{{ note.title|escapejs }}')">Delete</button>
              <button class="note-export" onclick="exportNote('{{ note.title|escapejs }}', `{{ note.content|escapejs }}`, `{{ note.tags|escapejs }}`)">Export</button>
              <button class="note-copy" onclick="copyNoteContent(`{{ note.content|escapejs }}`, '{{ note.title|escapejs }}')">Copy</button>
              <div class="note-reactions" id="reactions-{{ note.id }}">
                <button class="emoji-btn" onclick="addReaction({{ note.id }}, 'üëç')">üëç</button>
                <button class="emoji-btn" onclick="addReaction({{ note.id }}, '‚≠ê')">‚≠ê</button>
                <span>
                  {% for emoji, count in note.emoji_reactions.items %}
                    {{ emoji }} {{ count }}
                  {% endfor %}
                </span>
              </div>
          </div>
      {% endfor %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      
      setTimeout(function() {
        const flashMessages = document.getElementById("flash-messages");
        if (flashMessages) {
          flashMessages.style.transition = "opacity 0.5s ease";
          flashMessages.style.opacity = "0";
          setTimeout(() => flashMessages.remove(), 500); // fully remove after fade
        }
      }, 3000);

      function setDarkMode(enabled) {
        document.body.classList.toggle('dark-mode', enabled);
        localStorage.setItem('darkMode', enabled ? '1' : '0');
      }
        
      function syncDarkModeFromStorage() {
        const enabled = localStorage.getItem('darkMode') === '1';
        setDarkMode(enabled);
        const toggleBtn = document.getElementById('dark-mode-toggle');
        if (toggleBtn) {
          toggleBtn.textContent = enabled ? 'Light Mode' : 'Dark Mode';
        }
      }
        
      document.addEventListener('DOMContentLoaded', function() {
        syncDarkModeFromStorage();
        const toggleBtn = document.getElementById('dark-mode-toggle');
        if (toggleBtn) {
          toggleBtn.onclick = function() {
            const enabled = !(document.body.classList.contains('dark-mode'));
            setDarkMode(enabled);
            toggleBtn.textContent = enabled ? 'Light Mode' : 'Dark Mode';
          };
        }

        document.querySelectorAll('.note-card').forEach(function(card){
          const title = card.dataset.title;
          const color = localStorage.getItem('note-color-' + title);
          if(color) card.style.background = color;
          const nc = card.querySelector('.note-content');
          if (nc) nc.innerHTML = marked.parse(nc.textContent);
        });
      });

      // Feature 1: Confirmation Dialog for Delete
      function confirmDelete(noteId, noteTitle) {
        if (confirm(`Are you sure you want to delete the note "${noteTitle}"? This action cannot be undone.`)) {
          window.location.href = `/delete/${noteId}/`;
        }
      }

      // Feature 2: Copy Note Content Button
      function copyNoteContent(content, title) {
        navigator.clipboard.writeText(content).then(function() {
          showCopyFeedback(`"${title}" copied to clipboard!`);
        }).catch(function() {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = content;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showCopyFeedback(`"${title}" copied to clipboard!`);
        });
      }

      function showCopyFeedback(message) {
        const feedback = document.createElement('div');
        feedback.className = 'copy-feedback';
        feedback.textContent = message;
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2500);
      }

      function exportNote(title, content, tags) {
        const text = `Title: ${title}\nTags: ${tags}\n\n${content}`;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function addReaction(noteId, emoji) {
        fetch(`/notes/react/${noteId}/`, {
          method: "POST",
          headers: {"X-CSRFToken": "{{ csrf_token }}"},
          body: new URLSearchParams({emoji})
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            let html = "";
            for(const [e, c] of Object.entries(data.reactions)) html += `${e} ${c} `;
            document.getElementById("reactions-"+noteId).querySelector("span").textContent = html;
          }
        });
      }
    </script>
</body>
</html>
